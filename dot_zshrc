# Created by newuser for 5.9

# 基本的な環境変数
export LANG=ja_JP.UTF-8
export LC_ALL=ja_JP.UTF-8
export EDITOR=nvim


# PATHの設定 - 一箇所にまとめてシンプル化
export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$HOME/.local/share/nvim-linux-x86_64/bin:$PATH"
export PATH="$PATH:$HOME/.local/share/mise/installs/python/*/bin"
export GOPATH="$HOME/go"
export PATH="$GOPATH/bin:$PATH"
export PATH="$PATH:/snap/bin"
export SSH_AUTH_SOCK="$HOME/.1password/agent.sock"
export PATH="$HOME/.local/bin:$PATH"
GPG_TTY=`tty`
export GPG_TTY
# export MISE_VERBOSE=1

# 補完
autoload -Uz compinit
compinit -i

# 補完の設定
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}' # 大文字小文字を区別しない
zstyle ':completion:*' menu select # 補完メニューを有効化
zstyle ':completion:*' verbose yes # 補完の詳細を表示

# プラグイン管理
eval "$(starship init zsh)"
# 通常のシェル: フルアクティベート
eval "$(mise activate zsh)"
eval "$(sheldon source)"
eval "$(atuin init zsh)"
eval "$(zoxide init zsh)"

# Atuinと競合しないようzshの履歴を無効化
unset HISTFILE
setopt no_share_history
setopt no_extended_history

# Starship
unset PROMPT_EOL_MARK

# コマンド履歴 (Atuin使用のため無効化)
# HISTFILE=~/.zsh_history
# HISTSIZE=10000
# SAVEHIST=10000
# setopt hist_expire_dups_first
# setopt hist_verify
# setopt share_history
# setopt extended_history

# historyコマンドで時刻を表示
alias history='fc -il 1'

# alias
alias vim='nvim'
alias svim='vim ~/.note.gpg'

# ghqでクローンしたリポジトリへ簡単に移動するための関数
cgh() {
    local dir
    dir=$(ghq list | fzf --no-multi --exit-0 --query="$*" --preview="ls -FA1 $(ghq root)/{}")
    [ -n "$dir" ] && cd "$(ghq root)/$dir" || return
}

# cghと同じ挙動後、tmuxセッションを開始（名前はセッションのみ）
tgh() {
    cgh "$@" && {
        local parent_dir=$(basename $(dirname $PWD))
        local current_dir=$(basename $PWD | tr '.:' '_')
        local name="${parent_dir}/${current_dir}"
        local is_first_session=false
        # Check if tmux server is running
        if ! tmux list-sessions >/dev/null 2>&1; then
            is_first_session=true
        fi
        if [ -n "$TMUX" ]; then
            tmux new-session -d -s "$name" -c "$PWD"
            tmux switch-client -t "$name"
        else
            tmux new-session -s "$name" -c "$PWD"
        fi
        # If this was the first session, prompt for rename
        if $is_first_session; then
            read -r ans
            if [[ "$ans" =~ ^[Yy]$ ]]; then
                echo -n "New name: "
                read -r new_name
                if [ -n "$new_name" ]; then
                    tmux rename-session -t "$name" "$new_name"
                fi
            fi
        fi
    }
}

# カレントディレクトリでtmuxセッションを開始（名前はセッションのみ）
tm() {
    local name=$(basename $PWD | tr '.:' '_')
    local is_first_session=false
    # Check if tmux server is running
    if ! tmux list-sessions >/dev/null 2>&1; then
        is_first_session=true
    fi
    if [ -n "$TMUX" ]; then
        tmux new-session -d -s "$name" -c "$PWD"
        tmux switch-client -t "$name"
    else
        tmux new-session -s "$name" -c "$PWD"
    fi
}

tmux_fzf_window() {
    window_list=$(tmux list-windows -a -F '#{session_id}:#{window_index} #{session_name}:#{window_name}')
    target_index=$(echo $window_list | fzf | awk '{ print $1 }')
    tmux switch-client -t $target_index
}


# Cursorの実行
# code() {
#     # 既存のCursorプロセスをチェック
#     if pgrep -f "cursor.*--no-sandbox" > /dev/null; then
#         echo "Cursor is already running. Opening new window..."
#         command /usr/bin/cursor "$@" --reuse-window
#     else
#         echo "Cursor is not running. Starting new instance..."
#         command /usr/bin/cursor "$@" --no-sandbox --enable-features=UseOzonePlatform --ozone-platform=wayland --enable-wayland-ime --wayland-text-input-version=3 --password-store=basic > /dev/null 2>&1 &
#         disown
#     fi
# }
code() {
  unset GTK_IM_MODULE QT_IM_MODULE
  export XMODIFIERS="@im=fcitx"
  command /usr/bin/cursor "$@" \
    --no-sandbox \
    --enable-features=UseOzonePlatform \
    --ozone-platform=wayland \
    --enable-wayland-ime \
    --wayland-text-input-version=3 \
    > /dev/null 2>&1 &
  disown
}


# エイリアス
alias ls='eza --icons --color=always'
alias ll='ls -l'
alias la='ls -la'
alias l='ls -l'
alias gdm='git diff -w --no-color --ignore-blank-lines --minimal'
alias gls='git ls-files'
alias supabase='npx supabase'
alias cursor='code'

# Distroboxコンテナ準備の共通処理
_ensure_kali_running() {
    # Dockerサービスが起動しているか確認
    if ! systemctl is-active --quiet docker; then
        echo "→ Starting Docker service..."
        sudo systemctl start docker
    fi
    
    # Kaliコンテナが存在するか確認
    if ! distrobox list | grep -q "^kali"; then
        echo "→ Creating new Kali container (kali)..."
        distrobox create --name kali --image docker.io/kalilinux/kali-rolling:latest --home ~/distrobox/kali --additional-flags "--privileged"
    fi
    
    return 0
}

# Kaliコンテナ内でコマンドを実行するヘルパー関数
_distrobox_kali_exec() {
    _ensure_kali_running || return 1
    
    # distroboxのenterコマンドでbashコマンドを実行
    distrobox enter kali -- bash -c "$@"
    return $?
}

# Torを有効にしてKaliコンテナに入る（proxychains4使用）
k() {
    _ensure_kali_running || return 1

    echo "→ Entering Kali container with Tor (proxychains4)..."
    distrobox enter kali -- bash -c '
        export _JAVA_OPTIONS="-Dsun.java2d.uiScale=1.25"
        export _JAVA_AWT_WM_NONREPARENTING=2
        # systemd不要: ユーザーモードでTor起動（未起動なら）
        if ! pgrep -x tor >/dev/null 2>&1; then
            if ! command -v tor >/dev/null 2>&1; then
                echo "torが見つかりません。自動インストールしますか？ (y/n): "
                read -r ans
                if [[ "$ans" =~ ^[Yy]$ ]]; then
                    sudo apt-get update && sudo apt-get install -y tor proxychains4 || { echo "[ERROR] インストール失敗"; exit 1; }
                else
                    echo "[ERROR] torが必要です"; exit 1
                fi
            fi
            mkdir -p "$HOME/.tor"
            cat > "$HOME/.tor/torrc-k" <<EOF
ClientOnly 1
SocksPort 127.0.0.1:9050
DataDirectory $HOME/.tor
Log notice file $HOME/.tor/tor.log
Sandbox 0
EOF
            tor -f "$HOME/.tor/torrc-k" --RunAsDaemon 1 >/dev/null 2>&1 || { echo "[ERROR] Tor failed to start; opening normal shell (no proxy)"; exec /bin/bash --login; }
        fi
        # 以降のシェルを proxychains4 でラップ
        exec proxychains4 -q /bin/bash --login
    '
}

# 通常ネットワークモードでKaliコンテナに入る
k_pub() {
    _ensure_kali_running || return 1

    echo "→ Entering Kali container with normal network..."
    distrobox enter kali -- bash -c '
        export _JAVA_OPTIONS="-Dsun.java2d.uiScale=1.25"
        export _JAVA_AWT_WM_NONREPARENTING=2
        exec /bin/bash --login
    '
}

alias pbcopy='wl-copy'
alias b='~/.local/bin/biz_start.sh '

# pnpm
export PNPM_HOME="/home/tsuyoshi/.local/share/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac
# pnpm end

export PATH=/home/tsuyoshi/.local/share/pnpm:/home/tsuyoshi/src/out/Production/:/home/tsuyoshi/src/out/Production/:/home/tsuyoshi/.local/share/mise/installs/ruby/3.4.7/bin:/home/tsuyoshi/.local/share/mise/installs/go/1.25.4/bin:/home/tsuyoshi/.local/share/mise/installs/node/24.11.1/bin:/home/tsuyoshi/.local/share/mise/installs/python/3.14.0/bin:/home/tsuyoshi/.local/bin:/home/tsuyoshi/go/bin:/home/tsuyoshi/.local/bin:/home/tsuyoshi/.cargo/bin:/home/tsuyoshi/.local/share/nvim-linux-x86_64/bin:/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/bin/site_perl:/usr/bin/vendor_perl:/usr/bin/core_perl:/home/tsuyoshi/.local/share/mise/installs/python/*/bin:/snap/bin:/home/tsuyoshi/ghq/github.com/efg-technologies/zeed-browser/src/out/Production/
# Added by Zeed Browser init
export PATH="$PATH:/home/tsuyoshi/ghq/github.com/efg-technologies/zeed-browser/depot_tools"
