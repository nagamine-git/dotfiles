{{- if eq .chezmoi.os "linux" -}}
#! /bin/bash

# Stop on error
set -eu

# ??????????
install_if_missing() {
  local cmd=$1
  local name=${2:-$1}
  local install_cmd=$3
  
  if ! command -v "$cmd" &> /dev/null; then
    echo "Installing $name..."
    eval "$install_cmd"
  else
    echo "$name already installed, skipping"
  fi
}

# keyboard layout
sudo cp etc/keyd/default.conf /etc/keyd/default.conf

# bbr
# Enable BBR congestion control algorithm
echo "net.core.default_qdisc=fq" | sudo tee /etc/sysctl.d/99-bbr.conf
echo "net.ipv4.tcp_congestion_control=bbr" | sudo tee -a /etc/sysctl.d/99-bbr.conf

# Apply se
# 1password
curl -sS https://downloads.1password.com/linux/keys/1password.asc | gpg --import

# Install packages
paru -S --needed --noconfirm - < ~/pkglist.txt || echo "Some packages failed to install"

# ??????
sudo mkdir -p /usr/share/fonts

# Firge????che
if [ ! -f /usr/share/fonts/Firge35NerdConsole-Regular.ttf ]; then
    echo "Firge????????????????..."
    
    # GitHub API???????????????
    LATEST_RELEASE_INFO=$(curl -s https://api.github.com/repos/yuru7/Firge/releases/latest)
    FIRGE_VERSION=$(echo $LATEST_RELEASE_INFO | grep -o '"tag_name": "[^"]*' | cut -d'"' -f4 | sed 's/^v//')
    
    if [ -z "$FIRGE_VERSION" ]; then
        echo "???????????????????????????????????"
        FIRGE_VERSION="0.3.0"
    else
        echo "??????? ${FIRGE_VERSION} ???????"
    fi
    
    wget -O /tmp/firge.zip "https://github.com/yuru7/Firge/releases/download/v${FIRGE_VERSION}/FirgeNerd_v${FIRGE_VERSION}.zip"
    mkdir -p /tmp/firge
    unzip -o /tmp/firge.zip -d /tmp/firge
    sudo cp /tmp/firge/FirgeNerd_v${FIRGE_VERSION}/*.ttf /usr/share/fonts/
    rm -rf /tmp/firge /tmp/firge.zip
    fc-cache -f -v
else
    echo "Firge?????????????????????????????"
fi

# RobotoNotoSansJP
if [ ! -f /usr/share/fonts/Roboto-NotoSansJP-Regular.ttf ]; then
    echo "RobotoNotoSansJP????????????????..."
    [ -d /tmp/robotonoto ] && rm -rf /tmp/robotonoto
    git clone --depth 1 https://github.com/reindex-ot/RobotoNotoSansJP.git /tmp/robotonoto
    sudo cp /tmp/robotonoto/*.ttf /usr/share/fonts/
    rm -rf /tmp/robotonoto
    fc-cache -f -v
else
    echo "RobotoNotoSansJP?????????????????????????????"
fi

# ???????????????
install_if_missing starship starship "curl -sS https://starship.rs/install.sh | sh"
install_if_missing sheldon sheldon "curl --proto '=https' -fLsS https://rossmacarthur.github.io/install/crate.sh | bash -s -- --repo rossmacarthur/sheldon --to ~/.local/bin --force"

# droidcam
sudo dkms autoinstall
sudo modprobe -r v4l2loopback
sudo modprobe v4l2loopback devices=1 exclusive_caps=1 card_label="DroidCam 1920" max_width=1920 max_height=1080

# gh extension
gh extension install HikaruEgashira/gh-q
ghq get HikaruEgashira/gh-q

# tmux
git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm

# bluetooth
echo "Enabling Bluetooth service..."
sudo systemctl enable --now bluetooth
sudo usermod -a -G bluetooth $USER

{{- else if eq .chezmoi.os "darwin" -}}
#!/usr/bin/env bash

set -eu

log() {
  printf '%s\n' "$1"
}

ensure_xcode_clt() {
  if xcode-select -p >/dev/null 2>&1; then
    return
  fi
  log "Installing Xcode Command Line Tools..."
  xcode-select --install || true
}

ensure_homebrew() {
  if command -v brew >/dev/null 2>&1; then
    return
  fi
  log "Installing Homebrew..."
  NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
}

setup_homebrew_env() {
  local brew_bin=""
  if [ -x /opt/homebrew/bin/brew ]; then
    brew_bin=/opt/homebrew/bin/brew
  elif [ -x /usr/local/bin/brew ]; then
    brew_bin=/usr/local/bin/brew
  else
    brew_bin="$(command -v brew)"
  fi

  if [ -n "$brew_bin" ]; then
    eval "$($brew_bin shellenv)"
  fi
}

install_homebrew_bundle() {
  local brewfile="${HOME}/Brewfile"
  if [ ! -f "$brewfile" ]; then
    log "Brewfile not found at $brewfile, skipping brew bundle."
    return
  fi

  log "Installing Homebrew bundle packages..."
  brew bundle --file "$brewfile" --no-lock
}

install_gh_extension() {
  if ! command -v gh >/dev/null 2>&1; then
    return
  fi

  if ! gh extension list 2>/dev/null | grep -q 'HikaruEgashira/gh-q'; then
    log "Installing gh-q extension..."
    gh extension install HikaruEgashira/gh-q || log "gh-q extension install skipped."
  fi
}

sync_ghq_repo() {
  if ! command -v ghq >/dev/null 2>&1; then
    return
  fi

  if ! ghq list 2>/dev/null | grep -q '^github.com/HikaruEgashira/gh-q$'; then
    log "Fetching gh-q repository via ghq..."
    ghq get HikaruEgashira/gh-q || log "ghq get gh-q skipped."
  fi
}

install_tmux_plugins() {
  if [ -d "${HOME}/.tmux/plugins/tpm" ]; then
    return
  fi
  log "Cloning tmux plugin manager..."
  git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
}

ensure_xcode_clt
ensure_homebrew
setup_homebrew_env
install_homebrew_bundle
install_gh_extension
sync_ghq_repo
install_tmux_plugins

{{- else -}}
#!/usr/bin/env bash

set -eu

echo "Unsupported platform: {{ .chezmoi.os }}"
{{- end }}
