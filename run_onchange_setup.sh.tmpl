#! /usr/bin/env bash

# Stop on error
set -eu

# ??????????
install_if_missing() {
  local cmd=$1
  local name=${2:-$1}
  local install_cmd=$3
  
  if ! command -v "$cmd" &> /dev/null; then
    echo "Installing $name..."
    eval "$install_cmd"
  else
    echo "$name already installed, skipping"
  fi
}

{{- if eq .chezmoi.os "linux" }}
# ============================================================
# Linux????????
# ============================================================

# keyboard layout
sudo cp etc/keyd/default.conf /etc/keyd/default.conf

# bbr
# Enable BBR congestion control algorithm
echo "net.core.default_qdisc=fq" | sudo tee /etc/sysctl.d/99-bbr.conf
echo "net.ipv4.tcp_congestion_control=bbr" | sudo tee -a /etc/sysctl.d/99-bbr.conf

# Apply se
# 1password
curl -sS https://downloads.1password.com/linux/keys/1password.asc | gpg --import

# Install packages
paru -S --needed --noconfirm - < ~/pkglist.txt || echo "Some packages failed to install"

# ??????
sudo mkdir -p /usr/share/fonts

# Firge????che
if [ ! -f /usr/share/fonts/Firge35NerdConsole-Regular.ttf ]; then
    echo "Firge????????????????..."
    
    # GitHub API???????????????
    LATEST_RELEASE_INFO=$(curl -s https://api.github.com/repos/yuru7/Firge/releases/latest)
    FIRGE_VERSION=$(echo $LATEST_RELEASE_INFO | grep -o '"tag_name": "[^"]*' | cut -d'"' -f4 | sed 's/^v//')
    
    if [ -z "$FIRGE_VERSION" ]; then
        echo "???????????????????????????????????"
        FIRGE_VERSION="0.3.0"
    else
        echo "??????? ${FIRGE_VERSION} ???????"
    fi
    
    wget -O /tmp/firge.zip "https://github.com/yuru7/Firge/releases/download/v${FIRGE_VERSION}/FirgeNerd_v${FIRGE_VERSION}.zip"
    mkdir -p /tmp/firge
    unzip -o /tmp/firge.zip -d /tmp/firge
    sudo cp /tmp/firge/FirgeNerd_v${FIRGE_VERSION}/*.ttf /usr/share/fonts/
    rm -rf /tmp/firge /tmp/firge.zip
    fc-cache -f -v
else
    echo "Firge?????????????????????????????"
fi

# RobotoNotoSansJP
if [ ! -f /usr/share/fonts/Roboto-NotoSansJP-Regular.ttf ]; then
    echo "RobotoNotoSansJP????????????????..."
    [ -d /tmp/robotonoto ] && rm -rf /tmp/robotonoto
    git clone --depth 1 https://github.com/reindex-ot/RobotoNotoSansJP.git /tmp/robotonoto
    sudo cp /tmp/robotonoto/*.ttf /usr/share/fonts/
    rm -rf /tmp/robotonoto
    fc-cache -f -v
else
    echo "RobotoNotoSansJP?????????????????????????????"
fi

# droidcam
sudo dkms autoinstall
sudo modprobe -r v4l2loopback
sudo modprobe v4l2loopback devices=1 exclusive_caps=1 card_label="DroidCam 1920" max_width=1920 max_height=1080

# bluetooth
echo "Enabling Bluetooth service..."
sudo systemctl enable --now bluetooth
sudo usermod -a -G bluetooth $USER

{{- else if eq .chezmoi.os "darwin" }}
# ============================================================
# macOS????????
# ============================================================

# Homebrew????????????????
if ! command -v brew &> /dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Apple Silicon??????PATH??
    if [[ $(uname -m) == "arm64" ]]; then
        echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
fi

# ?????????????
brew install \
    git \
    neovim \
    tmux \
    fzf \
    ripgrep \
    fd \
    bat \
    eza \
    ghq \
    mise \
    starship \
    sheldon \
    atuin \
    gh

# ???????????Nerd Fonts?
brew tap homebrew/cask-fonts
brew install --cask font-firge-nerd-font || echo "Firge font already installed or unavailable"

{{- end }}

# ============================================================
# ?????????Linux/macOS????
# ============================================================

# ???????????????
install_if_missing starship starship "curl -sS https://starship.rs/install.sh | sh -s -- -y"
install_if_missing sheldon sheldon "curl --proto '=https' -fLsS https://rossmacarthur.github.io/install/crate.sh | bash -s -- --repo rossmacarthur/sheldon --to ~/.local/bin --force"

# gh extension
gh extension install HikaruEgashira/gh-q || echo "gh-q extension already installed"
ghq get HikaruEgashira/gh-q || echo "gh-q already cloned"

# tmux plugin manager
if [ ! -d ~/.tmux/plugins/tpm ]; then
    git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
else
    echo "tmux plugin manager already installed"
fi

echo "Setup completed successfully!"
